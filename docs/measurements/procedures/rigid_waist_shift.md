# IR LHC Local Coupling Corrections With a Rigid Waist Shift

!!! note
    Please keep in mind the [general checks](general_checks.md) for measurements.

??? info "The Procedure in Short"

      This methods aims to find the MQSX correction settings that would minimize betatron coupling and its impact on beam size _at the IP_.
      The method breaks the symmetry of the optics in the IR and forces local coupling RDTs to leak throughout the machine, which makes them measurable through the $|C^{-}|$.


      After global corrections are done and trimmed in the machine, one applies a rigid waist shift in a given IR and scans the colinearity knob for the value that minimizes the $|C^{-}|$.
      These settings, when taking away the rigid waist shift, will minimize local coupling and its impact at the IP.
      Additional info can be found in Felix's 2021 IPAC paper[^SoubeletIPACLocalCouplingCorrection] and 2023 PRAB paper[^SoubeletPRABLocalCouplingCorrection].

## Rigid Waist Shift & LSA Knobs

Some information about the rigid waist shift can be found in [this gallery page][rws_gallery]{target=_blank} from Felix's package's documentation.
Some details about the creation of these knobs and their addition in LSA can be found in this [LHC OMC logbook entry][logbook_entry]{target=_blank} and the ones that follow.

### Knob Setting Convention

Two different knobs are used for the waist shift that need to be trimmed in:

- The triplets knob, which generates the waist shift itself.
- The independent quadrupoles knob (Q4 - Q10), which re-matches the optics.

The unit setting of the triplet knob is an arbitrary definition, where a value of $\pm1$ corresponds to a $\pm 0.5$% change of the triplet powering, which leads to a waist shift of ~43-44cm in a given direction, for the $\beta^{*} = 30cm$ optics.
The knob setting is defined as follows, with regards to Beam1 (reverse for Beam2):

- Unit setting of +$1$: shifts the waist to the _left_ of the IP ($s_{waist}^{B1} < s_{IP}^{B1}$)
- Unit setting of -$1$: shifts the waist to the _right_ of the IP ($s_{waist}^{B1} > s_{IP}^{B1}$)

### The Knobs in LSA

Since the triplet knob for a unit setting of +$1$ is the exact opposite magnet powering of the knob for a unit setting of -$1$, only a single triplet knob per IP has been added to LSA, which can then be trimmed with a factor of $\pm1$.
On the other hand, the re-matching quadrupole knobs are specific to a given direction of the shift, so two of them per IP (one per direction) were added to LSA, with the _pos_ and _neg_ suffixes.
These should always be trimmed with a factor of $1$.

As a consequence, respect the following rules when applying the knobs below:

- When trimming the triplet knob with a factor of +$1$, use the _pos_ re-matching quadrupoles knob.
- When trimming the triplet knob with a factor of -$1$, use the _neg_ re-matching quadrupoles knob.

??? info "LSA Triplets Knobs"

    |  IP   |                        Knob Name                         |
    | :---: | :------------------------------------------------------: |
    |  IP1  | LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP1 |
    |  IP5  | LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP5 |

??? info "LSA Independent Quadrupoles Knobs"

    |  IP   |  Beam  |                      Knob Name                      |
    | :---: | :----: | :-------------------------------------------------: |
    |  IP1  | Beam 1 | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP1neg |
    |       |        | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP1pos |
    |       | Beam 2 | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1neg |
    |       |        | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1pos |
    |  IP5  | Beam 1 | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP5neg |
    |       |        | LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP5pos |
    |       | Beam 2 | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP5neg |
    |       |        | LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP5pos |

??? example "An Example"
    We wish to implement the waist shift at IP1, shifting the waist to the left of IP (for Beam1).
    To do so we need to apply the _LHCBEAM/MD_ATS_2020-05_04_BX_RigidWaistShift_Triplet_IP1_ with a factor of +$1$.

    Since we used a +$1$ factor on the triplet knob, the corresponding re-matching quadrupoles knobs to use are those with the _pos_ suffix, and they should be trimmed with a factor +$1$.
    The knobs to trim are then: _LHCBEAM/MD_ATS_2022_05_04_B1_RigidWaitsShift_IP1pos_ and _LHCBEAM/MD_ATS_2022_05_04_B2_RigidWaitsShift_IP1pos_.

!!! warning "Value of the Waist Shift"
      The waist shift from the generated knobs should be of about 43 to 44cm in either direction.
      In operation in the machine, it is likely that the optics aren't perfect and already present a small waist shift, which would add on top of the one generated by these knobs.
      This means one should expect the waists left and right to be slightly un-symmetric.

## Preliminary Setup

- [ ] <details class="nodeco"><summary>Do Global Corrections</summary>
      <p> This procedure needs global corrections to be trimmed in the machine first, so optics and _global coupling_ should be taken care of beforehand.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Scan the Colinearity Knob to Check Conditions</summary>
      <p> If time allows, ideally we would scan the colinearity knob to ensure we see very small variations of the $|C^{-}|$.
      If strong variations are noticed, then the expected conditions for the procedure are not met: either the phase advance between left and right MQSXs is off, or the $\sqrt{\beta_x \beta_y}$ is significantly wrong at these elements.
      </p></details>

## Procedure Per IP

This procedure is applied at the main experimental insertions (IR1 and IR5) where local corrections need to be established or checked.
Keep in mind that this does Beam1 and Beam2 at the same time, but different IPs cannot / should not be done in parallel.

!!! warning "Orbit & Tune Feedbacks"
      These feedbacks should be kept **ON** during the trim of the knobs and the procedure.

- [ ] <details class="nodeco"><summary>Trim in the Waist Shift Knob</summary>
      <p> Trim the prepared knob in the machine, for a certain direction (waist left/right of the IP).
      Remember that this affects both beams at the same time.
      On can take a few measurements to assess the impact of the optics.
      </p></details>

- [ ] <details class="nodeco"><summary>Trim in the Corresponding Optics Re-Matching Knobs</summary>
      <p> See the [Knobs in LSA](#the-knobs-in-lsa) section to determine which knobs to apply.
      At this point one should also kick a few times and ensure the optics were re-matched properly.
      </p></details>

- [ ] <details class="nodeco"><summary>Take a Reference Measurement</summary>
      <p> Do some kicks and measure $|C^{-}|$ and the optics.
      This will serve as a baseline reference of the coupling in the machine without any colinearity knob applied.
      </p></details>

- [ ] <details class="nodeco"><summary>Scan the Colinearity Knob</summary>
      <p> Trim the colinearity knob, about one or two units at a time depending on the range of values you want to cover.
      For each setting, do some kicks and measure the $|C^{-}|$ and the optics.
      </p></details>

- [ ] <details class="nodeco"><summary>Go Back to Nominal Machine</summary>
      <p> Trim out the rigid waist shift, and ensure that no drift from nominal is observed.
      If needed, do another round of global corrections.
      </p></details>

- [ ] <details class="nodeco"><summary>Trim in the Opposite Waist Shift Knob</summary>
      <p> Trim the prepared knob in the machine, for the other direction (waist right/left of the IP).
      On can take a few measurements to assess the impact of the optics.
      </p></details>

- [ ] <details class="nodeco"><summary>Trim in the Corresponding Optics Re-Matching Knobs</summary>
      <p> See the [Knobs in LSA](#the-knobs-in-lsa) section to determine which knobs to apply.
      At this point one should also kick a few times and ensure the optics were re-matched properly.
      </p></details>

- [ ] <details class="nodeco"><summary>Take a Reference Measurement</summary>
      <p> Do some kicks and measure $|C^{-}|$ and the optics.
      This will serve as a baseline reference of the coupling in the machine without any colinearity knob applied.
      </p></details>

- [ ] <details class="nodeco"><summary>Scan the Colinearity Knob</summary>
      <p> Trim the colinearity knob, about one or two units at a time depending on the range of values you want to cover.
      For each setting, do some kicks and measure the $|C^{-}|$ and the optics.
      </p></details>

- [ ] <details class="nodeco"><summary>Determine the Correction</summary>
      <p> Plot the evolution of the $|C^{-}|$ against the setting of the colinearity knob, and pick the setting that minimizes it.
      For best accuracy, one should substract the reference measurements (rematched optics without colinearity knob applied) for each measurement in the scans, eventually point by point.
      The curves for each beam might not be minimized exactly around the same point, and a compromise may be needed.
      Eventually do a fit of the data to get a better estimate of the correction.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Perform a Luminosity Scan of the Colinearity Knob</summary>
      <p> In commissioning and if conditions allow, one can validate and fine tune the correction with a luminosity scan.
      This has to be performed without a rigid waist shift: simply scan the colinearity knob around the previously determined correction setting, and measure the instantaneous luminosity.
      </p></details>

- [ ] <details class="nodeco"><summary>**Optional:** Do Global Corrections After Trimming</summary>
      <p> One might want to do another round of global corrections, mainly coupling, after applying the determined colinearity knob setting.
      </p></details>

[^SoubeletIPACLocalCouplingCorrection]:
    ??? abstract "Prospect for Interaction Region Local Coupling Correction in the LHC Run 3, `F. Soubelet, and T. Persson, and R. Tomás, and O. Apsimon, and C.P. Welsch`, [International Particle Accelerator Conference, 2021](https://accelconf.web.cern.ch/ipac2021/papers/mopab007.pdf){target=_blank}"
        ```
        @inproceedings{soubeletProspectInteractionRegion2021,
          author={Soubelet, F. and Persson, T. and Tomás, R. and Apsimon, O. and Welsch, C.P.},
          booktitle={Proceedings of the 12th International Particle Accelerator Conference},
          title={Prospect for Interaction Region Local Coupling Correction in the LHC Run 3},
          year={2021},
          url={https://accelconf.web.cern.ch/ipac2021/papers/mopab007.pdf},
          doi={10.18429/JACOW-IPAC2021-MOPAB007}
        }
        ```

[^SoubeletPRABLocalCouplingCorrection]:
    ??? abstract "Rigid Waist Shift: A New Method for Local Coupling Corrections in the LHC Interaction Regions, `F. Soubelet, T. Persson, R. Tomás, O. Apsimon and C. Welsch`, [Phys. Rev. Accel. Beams 25,     051001, 2023](https://link.aps.org/doi/10.1103/PhysRevAccelBeams.26.051001){target=_blank}"
        ```
        @article{Soubelet2023,
          author    = {Soubelet, Felix and Persson, Tobias and Tomás, Rogelio and Apsimon, Oznur and Welsch, Carsten P.},
          doi       = {10.1103/PhysRevAccelBeams.26.051001},
          issue     = {5},
          journal   = {Phys. Rev. Accel. Beams},
          month     = {May},
          numpages  = {13},
          pages     = {051001},
          publisher = {American Physical Society},
          title     = {Rigid waist shift: A new method for local coupling corrections in the LHC interaction regions},
          url       = {https://link.aps.org/doi/10.1103/PhysRevAccelBeams.26.051001},
          volume    = {26},
          year      = 2023
        }
        ```

*[rigid waist shift]: Shifting the waist of the beam from the IP point by un-balancing the powering of the left and right triplets in the IR.
*[MQSX]: The skew quadrupole correctors located next to Q3
*[LSA]: LHC Software Architecture
*[IP]: Interaction Point
*[IR]: Insertion Region
*[RDT]: Resonance Driving Terms
*[Colinearity Knob]: This is a powering setting of the MQSXs, which corresponds to a K1S value of  ±1E-4 m^-2.
*[colinearity knob]: This is a powering setting of the MQSXs, which corresponds to a K1S value of  ±1E-4 m^-2.

[rws_gallery]: https://fsoubelet.github.io/PyhDToolkit/gallery/demo_lhc_rigid_waist_shift.html
[logbook_entry]: https://be-op-logbook.web.cern.ch/elogbook-server/GET/showEventInLogbook/3545713
